name: Build
description: Builds and tests a Node.js project
inputs:
  artifact-name:
    default: build-artifact
    description: Artifacts name
  artifact-path:
    description: Artifacts path (relative to working directory)
    required: false
  package-manager:
    default: npm
    description: Package manager to use (`npm`, `yarn` or `pnpm`)
  build-command:
    description: Build command
    required: false
  postbuild-command:
    description: Command to run after building
    required: false
  prebuild-command:
    description: Command to run before building
    required: false
outputs:
  artifact-name:
    description: Name of the uploaded artifacts
    value: ${{ inputs.artifact-path && inputs.artifact-name || '' }}
  artifact-path:
    description: Path of the uploaded artifacts (relative to working directory)
    value: ${{ inputs.artifact-path }}
runs:
  using: composite
  steps:
    - name: Set up Node
      uses: actions/setup-node@v4
      with:
        cache: ${{ inputs.package-manager }}
        node-version-file: .node-version
    - name: Set up PNPM
      if: ${{ inputs.package-manager == 'pnpm' }}
      uses: pnpm/action-setup@v4
    - name: Install Node modules
      shell: bash
      run: ${{ inputs.package-manager == 'yarn' && 'yarn install' || inputs.package-manager == 'pnpm' && 'pnpm install' || 'npm install' }}
    - name: Prebuild
      if: ${{ inputs.prebuild-command }}
      shell: bash
      run: ${{ inputs.prebuild-command }}
    - name: Build
      shell: bash
      run: ${{ inputs.build-command || (inputs.package-manager == 'yarn' && 'yarn build' || inputs.package-manager == 'pnpm' && 'pnpm build' || 'npm run build') }}
    - name: Postbuild
      if: ${{ inputs.postbuild-command }}
      shell: bash
      run: ${{ inputs.postbuild-command }}
    - name: Store artifact
      if: ${{ inputs.artifact-path }}
      uses: actions/upload-artifact@v4
      with:
        name: ${{ inputs.artifact-name }}
        path: ${{ inputs.artifact-path }}
