<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Migrating an iOS App From Paid to Freemium</title>
    <meta charset="utf-8">
    <meta name="description" content="Andrew Wei, codenamed mu, is a software engineer, experience designer and illustrator.">
    <meta name="keywords" content="andrew,wei,andr,mu,engineer,designer,illustrator">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta property="og:url">
    <meta property="og:image" content="/og-image-3c57fca1f2.png">
    <meta property="og:title" content="Migrating an iOS App From Paid to Freemium">
    <meta property="og:description" content="Andrew Wei, codenamed mu, is a software engineer, experience designer and illustrator.">
    <link rel="shortcut icon" href="/favicon.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Migrating an iOS App From Paid to Freemium">
    <link href="/apple-touch-icon-180x180-precomposed-151af9722e.png" sizes="180x180" rel="apple-touch-icon">
    <link href="/apple-touch-icon-152x152-precomposed-4d4481414b.png" sizes="152x152" rel="apple-touch-icon">
    <link href="/apple-touch-icon-144x144-precomposed-c735943caf.png" sizes="144x144" rel="apple-touch-icon">
    <link href="/apple-touch-icon-120x120-precomposed-81dd7e0ad6.png" sizes="120x120" rel="apple-touch-icon">
    <link href="/apple-touch-icon-114x114-precomposed-1daf1d75d6.png" sizes="114x114" rel="apple-touch-icon">
    <link href="/apple-touch-icon-76x76-precomposed-f49e287ced.png" sizes="76x76" rel="apple-touch-icon">
    <link href="/apple-touch-icon-72x72-precomposed-a5412e18eb.png" sizes="72x72" rel="apple-touch-icon">
    <link href="/apple-touch-icon-60x60-precomposed-55aaa7669c.png" sizes="60x60" rel="apple-touch-icon">
    <link href="/apple-touch-icon-57x57-precomposed-e896f01ce1.png" sizes="57x57" rel="apple-touch-icon">
    <link href="/apple-touch-icon-precomposed-609906461e.png" rel="apple-touch-icon">
    <meta name="msapplication-config" content="/browserconfig.xml">
    <meta name="application-name" content="Migrating an iOS App From Paid to Freemium">
    <meta name="msapplication-tooltip" content="Get the latest updates!">
    <meta name="msapplication-window" content="width=1024;height=768">
    <meta name="msapplication-navbutton-color" content="#ff3300">
    <meta name="msapplication-starturl" content="/">
    <script type="text/javascript" src="https://unpkg.com/@webcomponents/webcomponentsjs@2.2.10/webcomponents-bundle.js"></script>
    <script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-108117457-1"></script>
    <script>window.dataLayer = window.dataLayer || [];
      function gtag() { dataLayer.push(arguments); }
      gtag('js', new Date());
      gtag('config', 'UA-108117457-1');
    </script>
    <link rel="stylesheet" href="/assets/stylesheets/application-7fc252c149.css">
  </head>
  <body><page-home id="home" name="home"><a class="down triangle" is="x-a" type="button" href="/logs/" name="down-button" style="display:none;"></a>
      <div is="name-card" name="name-card">
        <section class="logo"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 70 70" style="enable-background:new 0 0 70 70;" xml:space="preserve" preserveAspectRatio="xMidYMid">
            <circle class="dot-1" cx="5.3" cy="49.8" r="5.3"></circle>
            <circle class="dot-2" cx="5.3" cy="35" r="5.3"></circle>
            <circle class="dot-3" cx="5.3" cy="20.2" r="5.3"></circle>
            <circle class="dot-4" cx="20.2" cy="20.2" r="5.3"></circle>
            <circle class="dot-5" cx="35" cy="20.2" r="5.3"></circle>
            <circle class="dot-6" cx="35" cy="35" r="5.3"></circle>
            <circle class="dot-7" cx="35" cy="49.8" r="5.3"></circle>
            <circle class="dot-8" cx="49.8" cy="49.8" r="5.3"></circle>
            <circle class="dot-9" cx="64.7" cy="49.8" r="5.3"></circle>
            <circle class="dot-10" cx="64.7" cy="35" r="5.3"></circle>
            <circle class="dot-11" cx="64.7" cy="20.2" r="5.3"></circle>
          </svg></section>
        <section class="name">
          <h1 class="full-name">Andrew Wei</h1>
        </section>
        <section class="position"><span class="position" type="label">Engineer / Designer / Illustrator</span></section>
        <section class="connect"><a is="x-a" type="button" href="mailto:andrewscwei@gmail.com"><span type="icon" style="background-image: url(/assets/images/logs%2F439f2919-b36c-4403-837e-257d6bbde80c_email-icon.svg?auto=compress,format)"></span></a><a is="x-a" type="button" href="https://github.com/andrewscwei"><span type="icon" style="background-image: url(/assets/images/logs%2F92b82402-ce51-49db-a8b2-d2c8924cdbe0_github-icon.svg?auto=compress,format)"></span></a><a is="x-a" type="button" href="https://twitter.com/andrewscwei"><span type="icon" style="background-image: url(/assets/images/logs%2F719d8066-6750-4a08-afb7-a860a10482bc_twitter-icon.svg?auto=compress,format)"></span></a><a is="x-a" type="button" href="https://calculator3.andr.mu"><span type="icon" style="background-image: url(/assets/images/logs%2Fa4f8b935-bf95-45ae-bf82-7fbee9b994be_calculator3-icon.svg?auto=compress,format)"></span></a><a class="inactive" is="x-a" type="button" href="https://www.variante.io"><span type="icon" style="background-image: url(/assets/images/logs%2F3781e233-b368-4800-bebb-17c5e47955d1_vaiante-icon.svg?auto=compress,format)"></span></a><a class="inactive" is="x-a" type="button" href="https://www.grubbb.co"><span type="icon" style="background-image: url(/assets/images/logs%2F698dcb27-4e5e-4f9c-8473-0e5bb46af2d1_grubbb-icon.svg?auto=compress,format)"></span></a><a is="x-a" type="button" href="https://www.verb.studio"><span type="icon" style="background-image: url(/assets/images/logs%2F6bf8145f-5ea8-41d6-8cdd-d9c199a97806_verb-icon.svg?auto=compress,format)"></span></a><a is="x-a" type="button" href="https://dice.andr.mu"><span type="icon" style="background-image: url(/assets/images/logs%2F6d5406b1-3ec0-4915-abdf-f39a8ee95801_dice-icon.svg?auto=compress,format)"></span></a><a is="x-a" type="button" href="https://monitor.andr.mu"><span type="icon" style="background-image: url(/assets/images/logs%2F7021ac91-7a57-4815-90e7-90cf2011cdf7_monitoring-test-icon.svg?auto=compress,format)"></span></a><a is="x-a" type="button" href="https://www.aristotl.io"><span type="icon" style="background-image: url(/assets/images/logs%2F0240039f-2372-4fa9-af5c-18880f192e4c_aristotl-icon.svg?auto=compress,format)"></span></a><a is="x-a" type="button" href="https://www.sybl.io"><span type="icon" style="background-image: url(/assets/images/logs%2F5e961282-d08e-433d-960b-1e114a2bbc12_sybl.svg?auto=compress,format)"></span></a></section>
      </div>
    </page-home>
    <main id="page"><page-cover id="cover" name="cover">
        <figure name="background" style="background-image:url(/assets/images/logs/c7176847da3105ab5b14438c3a06515dcccd7a1b_calculator3.jpg?auto=compress,format)"></figure>
      </page-cover>
      <nav is="global-nav" id="global-nav" name="global-nav"><a class="logs" is="x-a" type="button" href="/logs/" name="grid-button"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 70 70" style="enable-background:new 0 0 70 70;" xml:space="preserve" preserveAspectRatio="xMidYMid">
            <path class="tl" d="M30,33H3c-1.7,0-3-1.3-3-3V3c0-1.7,1.3-3,3-3h27c1.7,0,3,1.3,3,3v27C33,31.7,31.7,33,30,33L30,33z M6,27h21V6H6V27L6,27z"></path>
            <path class="tr" d="M67,33H40c-1.7,0-3-1.3-3-3V3c0-1.7,1.3-3,3-3h27c1.7,0,3,1.3,3,3v27C70,31.7,68.7,33,67,33L67,33z M43,27h21V6H43V27    L43,27z"></path>
            <path class="bl" d="M30,70H3c-1.7,0-3-1.3-3-3V40c0-1.7,1.3-3,3-3h27c1.7,0,3,1.3,3,3v27C33,68.7,31.7,70,30,70L30,70z M6,64h21V43H6V64L6,64    z"></path>
            <path class="br" d="M67,70H40c-1.7,0-3-1.3-3-3V40c0-1.7,1.3-3,3-3h27c1.7,0,3,1.3,3,3v27C70,68.7,68.7,70,67,70L67,70z M43,64h21V43H43V64    L43,64z"></path>
          </svg></a></nav><page-log id="log" name="page">
        <div id="inner-page">
          <div name="header">
            <div name="info">
              <h1 name="title">Migrating an iOS App From Paid to Freemium</h1><span name="date" type="label">Jun 10 15</span>
              <div name="tags"><a class="tag slug" is="x-a" type="button" href="/logs/tag/objc/"><span type="label">objc</span></a><a class="tag slug" is="x-a" type="button" href="/logs/tag/mobile/"><span type="label">mobile</span></a><a class="tag slug" is="x-a" type="button" href="/logs/tag/ios/"><span type="label">ios</span></a></div>
            </div>
          </div>
          <div name="contents">
            <p>This log details out my recent effort in migrating the iOS app <a href="https://itunes.apple.com/us/app/calculator3/id828838134?ls=1&amp;mt=8">CalculatorÂ³</a> from paid model to freemium model with IAPs. Hopefully developers out there who are trying to do the same thing will find this log useful.</p>
            <h2 id="background">Background</h2>
            <ol>
              <li>I had a paid app with features fully accessible to users.</li>
              <li>I decided to convert this paid app into a free app and divide the features into in-app purchases with limited trial sessions. Why? So users can try out the features before they decide whether or not they want to pay for them, as opposed to a paid app where users must pay first before given a chance to try out the app.</li>
              <li>I need to make sure that rightful pre-owners of this app retain full access to all features because they already purchased the app while it was still paid.</li>
            </ol>
            <h2 id="approach">Approach</h2>
            <p>In iOS 7+, there exists an App Store receipt for every downloaded app which contains all the details that tell you exactly <strong>when</strong> and <strong>at what version</strong> the user first downloaded the app. At first glance, it seemed like all I had to do was to analyze the fields in the receipt upon app launch and determine whether the user is a pre-owner, then unlock the features silently.</p>
            <p>And so I began the implementation.</p>
            <p>I started off in the sandbox environment (obviously), with sandbox tester accounts, on an iOS 8 device. Following Apple's <a href="https://developer.apple.com/library/ios/releasenotes/General/ValidateAppStoreReceipt/Chapters/ValidateLocally.html#//apple_ref/doc/uid/TP40010573-CH1-SW2">guide</a>, I tried to retrieve the App Store receipt url using <code>[NSBundle mainBundle].appStoreReceiptURL</code>.</p>
            <blockquote>
              <h3 id="note">NOTE</h3>
              <p> In the sandbox environment, I was unable to locate the receipt unless I manually refresh it via <code>SKReceiptRefreshRequest</code>. During the production environment, however, the receipt is readily available upon the initial launch of the app. For safety reasons it is best to account for both cases and do not assume that the receipt is available, even though it should be in production.</p>
            </blockquote>
            <p>When I located the App Store receipt, I verified it locally with iTunes Store (see Apple's <a href="https://developer.apple.com/library/ios/releasenotes/General/ValidateAppStoreReceipt/Chapters/ValidateLocally.html#//apple_ref/doc/uid/TP40010573-CH1-SW2">guide</a>). In return I received JSON data that contains all the details of the receipt, which looks something like this in the sandbox environment:</p>
            <pre class=" line-numbers language-objectivec"><code class=" language-objectivec"><span class="token punctuation">{</span>
    environment <span class="token operator">=</span> Sandbox<span class="token punctuation">;</span>
    receipt <span class="token operator">=</span>     <span class="token punctuation">{</span>
        <span class="token string">"adam_id"</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token string">"app_item_id"</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token string">"application_version"</span> <span class="token operator">=</span> <span class="token number">108</span><span class="token punctuation">;</span>
        <span class="token string">"bundle_id"</span> <span class="token operator">=</span> <span class="token string">"mu.ghozt.Calculator"</span><span class="token punctuation">;</span>
        <span class="token string">"download_id"</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token string">"in_app"</span> <span class="token operator">=</span>      <span class="token punctuation">(</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token string">"original_application_version"</span> <span class="token operator">=</span> <span class="token string">"1.0"</span><span class="token punctuation">;</span>
        <span class="token string">"original_purchase_date"</span> <span class="token operator">=</span> <span class="token string">"2013-08-01 07:00:00 Etc/GMT"</span><span class="token punctuation">;</span>
        <span class="token string">"original_purchase_date_ms"</span> <span class="token operator">=</span> <span class="token number">1375340400000</span><span class="token punctuation">;</span>
        <span class="token string">"original_purchase_date_pst"</span> <span class="token operator">=</span> <span class="token string">"2013-08-01 00:00:00 America/Los_Angeles"</span><span class="token punctuation">;</span>
        <span class="token string">"receipt_type"</span> <span class="token operator">=</span> ProductionSandbox<span class="token punctuation">;</span>
        <span class="token string">"request_date"</span> <span class="token operator">=</span> <span class="token string">"2015-06-14 00:06:31 Etc/GMT"</span><span class="token punctuation">;</span>
        <span class="token string">"request_date_ms"</span> <span class="token operator">=</span> <span class="token number">1434240391409</span><span class="token punctuation">;</span>
        <span class="token string">"request_date_pst"</span> <span class="token operator">=</span> <span class="token string">"2015-06-13 17:06:31 America/Los_Angeles"</span><span class="token punctuation">;</span>
        <span class="token string">"version_external_identifier"</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
            <p>Note the 2 keys of interest: <code>original_application_version</code> and <code>original_purchase date</code>.</p>
            <blockquote>
              <h3 id="note-1">NOTE</h3>
              <p> In the sandbox environment, the <code>original_application_version</code> seems to always be <code>1.0</code>.</p>
            </blockquote>
            <p>The approach I took was to compare <code>original_application_version</code> against the new version number of the freemium update. Theoretically, if <code>original_application_version</code> is earlier than the new version, that would indicate that the user is a pre-owner, and therefore all the features should be unlocked. It was a fair assumption at the moment and I knew not a method to verify this in production. In fact, I was so hung up on this assumption that I thought it was unnecessary to make use of <code>original_purchase_date</code>. This soon proved to be a fatal mistake.</p>
            <blockquote>
              <h3 id="note-2">NOTE</h3>
              <p> I was unable to verify this in production. I have read that some developers are able to monitor the app receipt in production by first downloading their app from the App Store, then installing a dev version over it via Xcode. This did not work for me unfortunately, and I suspect that it has to do with iOS 8.</p>
            </blockquote>
            <p>So the app went live. I soon learned that some pre-owners were able to restore their features, but some <strong>weren't</strong>. I also learned that <strong>all new users got all features unlocked</strong>.</p>
            <p>WHAT???</p>
            <p>There was only one explanation - users had all features unlocked because <code>original_application_version</code> in their production receipt showed up as earlier than the newest version. Likewise, some pre-owners couldn't unlock their already paid features because their <code>original_application_version</code> showed up as later than the newest version. I implemented a function that compares version numbers and handles any number of sequences, and that was working perfectly. Everything worked fine in the sandbox environment with <code>original_application_version</code> being <code>1.0</code>. I even tested with random version numbers and everything seemed fine.</p>
            <p>I cried a little bit inside devastated by this major screw up, and finally began to seek for the answer. I started by looking for a way to see what the app receipt looks like in production. As I mentioned above, I had no luck doing so during development, but that was because I was testing with iOS 8 devices. By chance, I managed to get ahold of an iOS 7 device and <strong>successfully</strong> logged the production receipt to console using the following method:</p>
            <ol>
              <li>Download the production version of the app from the App Store</li>
              <li><strong>Do not launch the app</strong></li>
              <li>Install the dev version over it and debug it in Xcode</li>
              <li>Log the receipt to console and verify it</li>
            </ol>
            <p>With the production receipt in front of me, I discovered what the mistake was. I assumed that <code>original_application_version</code> refers to the version number of the app. It does not. It is actually referring to the <strong>build number</strong>. Is this documented? Yes it is. According to Apple's <a href="https://developer.apple.com/library/ios/releasenotes/General/ValidateAppStoreReceipt/Chapters/ReceiptFields.html">doc</a>:</p>
            <blockquote>
              <h3 id="original-application-version">Original Application Version</h3>
              <p> The version of the app that was originally purchased.</p>
              <p> ASN.1 Field Type 19
                ASN.1 Field Value UTF8STRING
                JSON Field Name original_application_version
                JSON Field Value string</p>
              <p> This corresponds to the value of CFBundleVersion (in iOS) or CFBundleShortVersionString (in OS X) in the Info.plist file when the purchase was originally made.</p>
              <p> In the sandbox environment, the value of this field is always â1.0â.</p>
              <p> Receipts prior to June 20, 2013 omit this field. It is populated on all new receipts, regardless of OS version. If you need the field but it is missing, manually refresh the receipt using the SKReceiptRefreshRequest class.</p>
            </blockquote>
            <p><code>CFBundleVersion</code> for iOS, and <code>CFBundleShortVersionString</code> for OS X. <code>CFBundleVersion</code> is the build number.</p>
            <p>If I took an extra measure of precaution and also compared the <code>original_purchase_date</code>, I might have avoided this regretful mistake.</p>
            <h2 id="conclusion">Conclusion</h2>
            <p>This incident welcomed a lot of 1-star reviews. Fellow developers, please be extra careful if you are also trying to convert your paid app to a freemium app using the same approach.</p>
          </div>
          <div name="footer"><button class="prev post" is="x-button" type="button" style="visibility:hidden;"><span class="prev" type="icon"></span><span type="label">prev</span></button><button class="arrow" is="x-button" type="button" name="top-button"><span class="up" type="icon"></span></button><a class="next post" is="x-a" type="button" href="/logs/push-deploy-a-django-app-with-bitnami-jenkins-on-google/"><span class="next" type="icon"></span><span type="label">next</span></a></div>
          <div name="related">
            <div class="tags" name="tags"><button class="tag" is="x-button" type="button" disabled="disabled"><span type="label">related</span></button></div>
            <div class="grid"><a type="button" is="log-entry" href="/logs/the-shunting-yard-algorithm/" name="entry">
                <div class="wrapper">
                  <h2 class="title">The Shunting-Yard Algorithm</h2><span class="date" type="label">Oct 09 11</span><span class="number" type="label">5</span>
                </div>
              </a><a type="button" is="log-entry" href="/logs/google-compute-engine-setup-for-django-app-with-uwsgi/" name="entry">
                <div class="wrapper">
                  <h2 class="title">Google Compute Engine Setup for Django App with uWSGI and Nginx</h2><span class="date" type="label">Jun 01 15</span><span class="number" type="label">12</span>
                </div>
              </a><a type="button" is="log-entry" href="/logs/push-deploy-a-django-app-with-bitnami-jenkins-on-google/" name="entry">
                <div class="wrapper">
                  <h2 class="title">Push-Deploy a Django App with Bitnami Jenkins on Google Cloud Engine</h2><span class="date" type="label">Jun 02 15</span><span class="number" type="label">13</span>
                </div>
              </a></div>
          </div>
        </div>
      </page-log>
    </main>
    <script src="/assets/javascripts/polyfills-4df15158e5.js"></script>
    <script src="/assets/javascripts/common-a589f09cab.js"></script>
    <script src="/assets/javascripts/application-a1f774b4b0.js"></script>
  </body>
</html>
