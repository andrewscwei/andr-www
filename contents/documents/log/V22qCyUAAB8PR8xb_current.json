{
  "id": "V22qCyUAAB8PR8xb",
  "uid": "google-compute-engine-setup-for-django-app-with-uwsgi",
  "url": null,
  "type": "log",
  "href": "https://andr-mu.cdn.prismic.io/api/v2/documents/search?ref=ZwSajRAAACIA6x5O&q=%5B%5B%3Ad+%3D+at%28document.id%2C+%22V22qCyUAAB8PR8xb%22%29+%5D%5D",
  "tags": [
    "systems"
  ],
  "first_publication_date": null,
  "last_publication_date": "2017-08-31T02:12:37+0000",
  "slugs": [
    "google-compute-engine-setup-for-django-app-with-uwsgi-and-nginx"
  ],
  "linked_documents": [],
  "lang": "en-us",
  "alternate_languages": [],
  "data": {
    "title": [
      {
        "type": "heading1",
        "text": "Google Compute Engine Setup for Django App with uWSGI and Nginx",
        "spans": []
      }
    ],
    "synopsis": [],
    "cover": {
      "dimensions": {
        "width": 1920,
        "height": 1080
      },
      "alt": null,
      "copyright": null,
      "url": "https://images.prismic.io/andr-mu/02876c2e87bb92113c866bb54a76e7293b735f6f_django.png?auto=compress,format",
      "id": "V3IJnyUAAPIbU3nI",
      "edit": {
        "x": 0,
        "y": 0,
        "zoom": 1,
        "background": "transparent"
      }
    },
    "markdown": [
      {
        "type": "preformatted",
        "text": "This log demonstrates how to set up a [Django](https://www.djangoproject.com/) app on [Google Compute Engine](https://cloud.google.com/compute/) and serve it using [uWSGI](https://uwsgi-docs.readthedocs.org) and [Nginx](http://wiki.nginx.org/Main) from **scratch**. Assume the following:\n\n1.  The app uses a VM instance on Debian OS. This log uses the *Debian GNU/Linux 7.8 (wheezy)* image on GCE.\n2.  The name of the app is `example.com` and its base path on the VM instance is `/srv`.\n3.\tThe app has a [Git](https://git-scm.com) repo.\n4. \tThe database which the app uses will be set up in the same VM instance as the app.\n5.\tThe app is generated by [generator-vars-django](https://github.com/andrewscwei/generator-vars-django), which uses [Gulp](http://gulpjs.com) as its asset pipeline, hence depends on [Node.js](https://nodejs.org).\n\nLet's begin. SSH into your instance and ensure you have `sudo` access.\n\n## Installing Dependencies\n\n1.\tUpdate APT packages, no explanations needed.\n\n    ```bash\n    $ sudo apt-get update\n    ```\n\n2.\tInstall [Git](https://git-scm.com) to pull down the app's source code.\n\n    ```bash\n    $ sudo apt-get install git-core\n    ```\n\n3.\tInstall [Upstart](http://upstart.ubuntu.com) if the system is still using [SysVinit](https://wiki.archlinux.org/index.php/SysVinit). This will make writing startup scripts much easier later on.\n\n    ```bash\n    $ sudo apt-get install upstart\n    ```\n\tWhen prompted, enter *'Yes, do as I say!'*.\n\n4.\tInstall `nvm` so you have the freedom to juggle between different `npm` versions. Install it globally to save yourself from the trouble of managing global node packages later on. This allows you to run `nvm` with `sudo`. Follow this [GitHub repo](https://github.com/xtuple/nvm) or simply run:\n\n    ```bash\n    $ sudo wget -qO- https://raw.githubusercontent.com/xtuple/nvm/master/install.sh | sudo bash\n    ```\n\n5. \tInstall `node` via `nvm`. Pick the version of your choice.\n\n    ```bash\n    $ sudo nvm ls-remote\n    $ sudo nvm install x.xx.x\n    ```\n\n6.\tInstall `gulp` globally to build the app (assuming you have [Gulp](http://gulpjs.com) setup, which comes with [generator-vars-django](https://github.com/andrewscwei/generator-vars-django):\n\n    ```bash\n    sudo npm install -g gulp\n    ```\n\n7. \tInstall `python` and `pip` as needed by any Django app.\n\n    ```bash\n    $ sudo apt-get install python-pip python-virtualenv python-dev build-essential\n    ```\n\n8. \tInstall database of your choice. Here are a couple examples:\n\n    #### MySQL\n\n    ```bash\n    $ sudo apt-get install mysql-server\n    $ sudo apt-get install python-mysqldb\n    ```\n\n    #### PostgreSQL\n\n\t```bash\n    $ sudo apt-get install libpq-dev python-dev python-psycopg2\n\t$ sudo apt-get install postgresql postgresql-contrib\n    ```\n\n9.\tInstall uWSGI. Do it through `pip` instead of `apt-get` to get the most updated version.\n\n    ```bash\n    $ sudo pip install uwsgi\n    ```\n\n10.\tInstall Nginx:\n\n    ```bash\n    $ sudo apt-get install nginx\n    ```\n\n## Database Configuration\n\nYou will need to set up your database before you can run a Django app (if you are not using SQLite). Basically you need to create a new database with a new owner and password. Here's a quick guide for MySQL and PostgreSQL:\n\n#### MySQL\n\n```bash\n$ mysql_secure_installation\n$ mysql --user=root --password={password}\n$ mysql> create database {db_name};\n$ mysql> quit;\n```\n\n#### PostgreSQL\n\n```bash\n$ sudo su postgres\n$ createuser -P\n$ createdb --owner username dbname\n$ exit\n```\n\n## Python Virtual Environment Setup\n\nPython packages required by the app will be installed into a virtual environment. Create one in `/srv`:\n\n```bash\n$ sudo virtualenv /srv\n```\n\nBefore sourcing it, add any environment variables your app needs to ```/srv/bin/activate```, such as the Django secret key. Assuming the app is generated by [generator-vars-django](https://github.com/andrewscwei/generator-vars-django), all the database credentials need to go in there as well.\n\n```bash\n$ sudo nano /srv/bin/activate\n```\n\nAdd the following to the end of the file (replace `{xxxx}` with your own values):\n\n```bash\nexport DJANGO_SECRET_KEY=\"{django_secret_key}\"\nexport DJANGO_DB_NAME=\"{db_name}\"\nexport DJANGO_DB_USER=\"{db_user}\"\nexport DJANGO_DB_PASS=\"{db_password}\"\nexport DJANGO_DB_HOST=\"localhost\"\nexport DJANGO_DB_PORT=\"{db_port}\"\n```\n\nFinally, source it:\n\n```bash\n$ source /srv/bin/activate\n```\n\n## App Setup\n\n1.\tClone the source code to `/srv`. It is best to have the source code inside a folder like `example.com`. This should already be taken care of if the app is generated by [generator-vars-django](https://github.com/andrewscwei/generator-vars-django).\n\n2. \tInstall Python dependencies. Remember to activate the virtual environment first.\n\t```bash\n    $ sudo pip install -r requirements.txt\n    ```\n\n    Double check that the packages were installed to the virtual environment:\n\n    ```bash\n    $ which django-admin\n    ```\n\n    If it's not, you should redo this step. It might be because the command was executed using `sudo`. In which case you will either need to give your account write permission for `/srv` so you can run `pip install` without `sudo`, or you can simply login as `root` by doing:\n\n    ```bash\n    $ sudo su -\n    ```\n\n3.\tInstall Node modules:\n\n\t```bash\n    $ sudo npm install\n\t```\n\n4.\tDo the initial Django migration:\n\n\t```bash\n    $ gulp migrate\n    ```\n\n5.\tBuild it:\n\n\t```bash\n    $ gulp\n    ```\n\n\tYou should now have the app built and deployed to the `build` directory.\n\n## Serving the App\n\n#### Nginx Setup\n\n[generator-vars-django](https://github.com/andrewscwei/generator-vars-django) comes with a default `example.com_nginx.conf` file. Symlink that so Nginx can see it.\n\n```bash\n$ sudo ln -s /srv/example.com_nginx.conf /etc/nginx/sites-enabled/\n```\n\nEdit whatever you need in there. It should look like this:\n\n```nginx\n# The upstream component nginx needs to connect to.\nupstream django {\n    server unix:///srv/variante.io/variante.io.sock;\n}\n\n# Configuration of the server.\nserver {\n    # The port in which the site will be served on.\n    listen 80;\n\n    # The domain name it will serve for (or the external IP).\n    server_name example.com;\n\n    # Character encoding.\n    charset utf-8;\n\n    # Max upload size.\n    client_max_body_size 75M;\n\n    # Django media path.\n    location /media {\n        alias /srv/example.com/build/media;\n    }\n\n    # Django static path.\n    location /static {\n        alias /srv/example.com/build/static;\n        expires 90d;\n    }\n\n    # Send all non-media requests to the Django server.\n    location / {\n        uwsgi_pass django;\n        include /srv/example.com/uwsgi_params;\n    }\n}\n```\n\nMake sure that you also have the `uwsgi_params` file in the specified place. It also comes with [generator-vars-django](https://github.com/andrewscwei/generator-vars-django). If not, it looks like this:\n\n```ini\nuwsgi_param  QUERY_STRING       $query_string;\nuwsgi_param  REQUEST_METHOD     $request_method;\nuwsgi_param  CONTENT_TYPE       $content_type;\nuwsgi_param  CONTENT_LENGTH     $content_length;\n\nuwsgi_param  REQUEST_URI        $request_uri;\nuwsgi_param  PATH_INFO          $document_uri;\nuwsgi_param  DOCUMENT_ROOT      $document_root;\nuwsgi_param  SERVER_PROTOCOL    $server_protocol;\nuwsgi_param  HTTPS              $https if_not_empty;\n\nuwsgi_param  REMOTE_ADDR        $remote_addr;\nuwsgi_param  REMOTE_PORT        $remote_port;\nuwsgi_param  SERVER_PORT        $server_port;\nuwsgi_param  SERVER_NAME        $server_name;\n```\n\nRestart Nginx:\n\n```bash\n$ sudo service nginx restart\n```\n\nAt this point you would probably see a 500 error if you try to access the site.\n\n#### uWSGI Setup\n\nWe will be setting uWSGI up in emperor mode which will be spawning instances for each vassal it finds.\n\nFirst create the directories for storing these vassals.\n\n```bash\n$ sudo mkdir /etc/uwsgi\n$ sudo mkdir /etc/uwsgi/vassals\n```\n\nSymlink `example.com_uwsgi.ini` so the emperor can see it:\n\n```bash\n$ sudo ln -s /srv/example.com_uwsgi.ini /etc/uwsgi/vassals/\n```\n\nYou should tweak this file accordingly. The file looks like this:\n\n```ini\n[uwsgi]\n\n# Variables.\nbase-path = /srv\napp-name = example.com\napp-path = %(base-path)/%(app-name)\nenv-path = %(base-path)\n\n# Configurations.\nchdir = %(app-path)/build\nmodule = project.wsgi\nhome = %(env-path)\nmaster = true\nprocesses = 10\nsocket = %(app-path)/%(app-name).sock\nchmod-socket = 666\nvacuum = true\n```\n\nThis is the most basic configuration you need to get things up and running. Note that `chmod-socket` is set to `666`, which is very permissive. Tweak that accordingly. Also make sure that `env-path` matches the path to your `virtualenv`.\n\nNow try running uWSGI in emperor mode:\n\n```bash\n$ sudo uwsgi --emperor /etc/uwsgi/vassals\n```\n\nYou may encounter the following issues:\n\n1.  You get an error about permission issues with writing to the UDP socket. You might need to change the owner of `/srv/example.com` to the Nginx owner/group, which is probably `www-data:www-data`:\n\n    ```bash\n    $ sudo chown -R www-data /srv/example.com\n    $ sudo chmod -R 775 /srv/example.com\n    ```\n\n2.  You get a warning about running uWSGI in root. You can set the `gid` and `uid` to the Nginx user (probably `www-data`) either in the ini file or in the command, like so:\n\n    ```bash\n    $ uwsgi --emperor /etc/uwsgi/vassals --uid www-data --gid www-data\n    ```\n\nThe last step is to make sure that the emperor starts whenever the system reboots. `upstart` finally comes into play. Create a new file:\n\n```bash\n$ sudo nano /etc/init/uwsgi.conf\n```\n\nAdd the following:\n\n```ini\ndescription \"uWSGI Emperor\"\n\nstart on runlevel [2345]\nstop on runlevel [!2345]\n\nscript\n    . /srv/bin/activate\n    uwsgi --emperor /etc/uwsgi/vassals\nend script\n```\n\nThis script will execute everytime the system boots up and it basically first activates the virtual environment so that all the environment variables are loaded (i.e. the Django secret key), and then kickstarts the emperor.\n\n## Verifying the Live Site\n\nOpen up your browser and navigate to the site. It should be now be served properly with Nginx and uWSGI. You might encounter the following issues:\n\n1.  You are still getting a 500 error. The best thing to do is to check the Nginx logs. It's in `/var/log/nginx/error.log`.\n\n2.  You are instead getting a 400 error. You can debug this using your browser console to see what is wrong. If you get a GET request fail on the domain itself, chances are you forgot to add your domain to the `ALLOWED_HOSTS` of your Django project settings.\n\n## Related Articles\n\n1.  [A Tutorial for Deploying a Django Application that Uses Numpy and Scipy to Google Compute Engine Using Apache2 and modwsgi](http://www.datacommunitydc.org/blog/2013/12/a-tutorial-for-deploying-a-django-application-that-uses-numpy-and-scipy-to-google-compute-engine-using-apache2-and-modwsgi)\n\n2.  [Installing Nginx, WWSGI and Python on Google Compute Engine](http://www.denisigo.com/2013/07/nginx-uwsgi-python-on-compute-engine/)\n\n3.  [Setting up Django and your web server with uWSGI and Nginx](http://uwsgi-docs.readthedocs.org/en/latest/tutorials/Django_and_nginx.html)\n\n4.  [Setting up Django with Nginx, Gunicorn, virtualenv, supervisor and PostgreSQL](http://michal.karzynski.pl/blog/2013/06/09/django-nginx-gunicorn-virtualenv-supervisor/)\n\n5.  [Using uwsgi the right way](http://guoqiao.farbox.com/post/2014/0416-use-uwsgi-the-right-way)\n\n6.  [How To Set Up uWSGI and Nginx to Serve Python Apps on Ubuntu 14.04](https://www.digitalocean.com/community/tutorials/how-to-set-up-uwsgi-and-nginx-to-serve-python-apps-on-ubuntu-14-04)",
        "spans": []
      }
    ],
    "date": "2015-06-01",
    "mathjax": null,
    "prism": "Yes"
  }
}
