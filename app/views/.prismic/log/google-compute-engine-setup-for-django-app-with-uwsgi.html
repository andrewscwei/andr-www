---
title: 'Google Compute Engine Setup for Django App with uWSGI and Nginx'
cover: 'https://andr-mu.cdn.prismic.io/andr-mu/02876c2e87bb92113c866bb54a76e7293b735f6f_django.png'
markdown: "<p>This log demonstrates how to set up a <a href=\"https://www.djangoproject.com/\">Django</a> app on <a href=\"https://cloud.google.com/compute/\">Google Compute Engine</a> and serve it using <a href=\"https://uwsgi-docs.readthedocs.org\">uWSGI</a> and <a href=\"http://wiki.nginx.org/Main\">Nginx</a> from <strong>scratch</strong>. Assume the following:</p>\n<ol>\n<li>The app uses a VM instance on Debian OS. This log uses the <em>Debian GNU/Linux 7.8 (wheezy)</em> image on GCE.</li>\n<li>The name of the app is <code>example.com</code> and its base path on the VM instance is <code>/srv</code>.</li>\n<li>The app has a <a href=\"https://git-scm.com\">Git</a> repo.</li>\n<li>The database which the app uses will be set up in the same VM instance as the app.</li>\n<li>The app is generated by <a href=\"https://github.com/andrewscwei/generator-vars-django\">generator-vars-django</a>, which uses <a href=\"http://gulpjs.com\">Gulp</a> as its asset pipeline, hence depends on <a href=\"https://nodejs.org\">Node.js</a>.</li>\n</ol>\n<p>Let&#39;s begin. SSH into your instance and ensure you have <code>sudo</code> access.</p>\n<h2 id=\"installing-dependencies\">Installing Dependencies</h2>\n<ol>\n<li><p>Update APT packages, no explanations needed.</p>\n<pre><code class=\"language-bash\">$ sudo apt-get update\n</code></pre>\n</li>\n<li><p>Install <a href=\"https://git-scm.com\">Git</a> to pull down the app&#39;s source code.</p>\n<pre><code class=\"language-bash\">$ sudo apt-get install git-core\n</code></pre>\n</li>\n<li><p>Install <a href=\"http://upstart.ubuntu.com\">Upstart</a> if the system is still using <a href=\"https://wiki.archlinux.org/index.php/SysVinit\">SysVinit</a>. This will make writing startup scripts much easier later on.</p>\n<pre><code class=\"language-bash\">$ sudo apt-get install upstart\n</code></pre>\n<p>When prompted, enter <em>&#39;Yes, do as I say!&#39;</em>.</p>\n</li>\n<li><p>Install <code>nvm</code> so you have the freedom to juggle between different <code>npm</code> versions. Install it globally to save yourself from the trouble of managing global node packages later on. This allows you to run <code>nvm</code> with <code>sudo</code>. Follow this <a href=\"https://github.com/xtuple/nvm\">GitHub repo</a> or simply run:</p>\n<pre><code class=\"language-bash\">$ sudo wget -qO- https://raw.githubusercontent.com/xtuple/nvm/master/install.sh | sudo bash\n</code></pre>\n</li>\n<li><p>Install <code>node</code> via <code>nvm</code>. Pick the version of your choice.</p>\n<pre><code class=\"language-bash\">$ sudo nvm ls-remote\n$ sudo nvm install x.xx.x\n</code></pre>\n</li>\n<li><p>Install <code>gulp</code> globally to build the app (assuming you have <a href=\"http://gulpjs.com\">Gulp</a> setup, which comes with <a href=\"https://github.com/andrewscwei/generator-vars-django\">generator-vars-django</a>:</p>\n<pre><code class=\"language-bash\">sudo npm install -g gulp\n</code></pre>\n</li>\n<li><p>Install <code>python</code> and <code>pip</code> as needed by any Django app.</p>\n<pre><code class=\"language-bash\">$ sudo apt-get install python-pip python-virtualenv python-dev build-essential\n</code></pre>\n</li>\n<li><p>Install database of your choice. Here are a couple examples:</p>\n<h4 id=\"mysql\">MySQL</h4>\n<pre><code class=\"language-bash\">$ sudo apt-get install mysql-server\n$ sudo apt-get install python-mysqldb\n</code></pre>\n<h4 id=\"postgresql\">PostgreSQL</h4>\n<pre><code class=\"language-bash\">$ sudo apt-get install libpq-dev python-dev python-psycopg2\n$ sudo apt-get install postgresql postgresql-contrib\n</code></pre>\n</li>\n<li><p>Install uWSGI. Do it through <code>pip</code> instead of <code>apt-get</code> to get the most updated version.</p>\n<pre><code class=\"language-bash\">$ sudo pip install uwsgi\n</code></pre>\n</li>\n<li><p>Install Nginx:</p>\n<pre><code class=\"language-bash\">$ sudo apt-get install nginx\n</code></pre>\n</li>\n</ol>\n<h2 id=\"database-configuration\">Database Configuration</h2>\n<p>You will need to set up your database before you can run a Django app (if you are not using SQLite). Basically you need to create a new database with a new owner and password. Here&#39;s a quick guide for MySQL and PostgreSQL:</p>\n<h4 id=\"mysql\">MySQL</h4>\n<pre><code class=\"language-bash\">$ mysql_secure_installation\n$ mysql --user=root --password={password}\n$ mysql&gt; create database {db_name};\n$ mysql&gt; quit;\n</code></pre>\n<h4 id=\"postgresql\">PostgreSQL</h4>\n<pre><code class=\"language-bash\">$ sudo su postgres\n$ createuser -P\n$ createdb --owner username dbname\n$ exit\n</code></pre>\n<h2 id=\"python-virtual-environment-setup\">Python Virtual Environment Setup</h2>\n<p>Python packages required by the app will be installed into a virtual environment. Create one in <code>/srv</code>:</p>\n<pre><code class=\"language-bash\">$ sudo virtualenv /srv\n</code></pre>\n<p>Before sourcing it, add any environment variables your app needs to <code>/srv/bin/activate</code>, such as the Django secret key. Assuming the app is generated by <a href=\"https://github.com/andrewscwei/generator-vars-django\">generator-vars-django</a>, all the database credentials need to go in there as well.</p>\n<pre><code class=\"language-bash\">$ sudo nano /srv/bin/activate\n</code></pre>\n<p>Add the following to the end of the file (replace <code>{xxxx}</code> with your own values):</p>\n<pre><code class=\"language-bash\">export DJANGO_SECRET_KEY=&quot;{django_secret_key}&quot;\nexport DJANGO_DB_NAME=&quot;{db_name}&quot;\nexport DJANGO_DB_USER=&quot;{db_user}&quot;\nexport DJANGO_DB_PASS=&quot;{db_password}&quot;\nexport DJANGO_DB_HOST=&quot;localhost&quot;\nexport DJANGO_DB_PORT=&quot;{db_port}&quot;\n</code></pre>\n<p>Finally, source it:</p>\n<pre><code class=\"language-bash\">$ source /srv/bin/activate\n</code></pre>\n<h2 id=\"app-setup\">App Setup</h2>\n<ol>\n<li><p>Clone the source code to <code>/srv</code>. It is best to have the source code inside a folder like <code>example.com</code>. This should already be taken care of if the app is generated by <a href=\"https://github.com/andrewscwei/generator-vars-django\">generator-vars-django</a>.</p>\n</li>\n<li><p>Install Python dependencies. Remember to activate the virtual environment first.</p>\n<pre><code class=\"language-bash\">$ sudo pip install -r requirements.txt\n</code></pre>\n<p>Double check that the packages were installed to the virtual environment:</p>\n<pre><code class=\"language-bash\">$ which django-admin\n</code></pre>\n<p>If it&#39;s not, you should redo this step. It might be because the command was executed using <code>sudo</code>. In which case you will either need to give your account write permission for <code>/srv</code> so you can run <code>pip install</code> without <code>sudo</code>, or you can simply login as <code>root</code> by doing:</p>\n<pre><code class=\"language-bash\">$ sudo su -\n</code></pre>\n</li>\n<li><p>Install Node modules:</p>\n<pre><code class=\"language-bash\">$ sudo npm install\n</code></pre>\n</li>\n<li><p>Do the initial Django migration:</p>\n<pre><code class=\"language-bash\">$ gulp migrate\n</code></pre>\n</li>\n<li><p>Build it:</p>\n<pre><code class=\"language-bash\">$ gulp\n</code></pre>\n<p>You should now have the app built and deployed to the <code>build</code> directory.</p>\n</li>\n</ol>\n<h2 id=\"serving-the-app\">Serving the App</h2>\n<h4 id=\"nginx-setup\">Nginx Setup</h4>\n<p><a href=\"https://github.com/andrewscwei/generator-vars-django\">generator-vars-django</a> comes with a default <code>example.com_nginx.conf</code> file. Symlink that so Nginx can see it.</p>\n<pre><code class=\"language-bash\">$ sudo ln -s /srv/example.com_nginx.conf /etc/nginx/sites-enabled/\n</code></pre>\n<p>Edit whatever you need in there. It should look like this:</p>\n<pre><code class=\"language-nginx\"># The upstream component nginx needs to connect to.\nupstream django {\n    server unix:///srv/variante.io/variante.io.sock;\n}\n\n# Configuration of the server.\nserver {\n    # The port in which the site will be served on.\n    listen 80;\n\n    # The domain name it will serve for (or the external IP).\n    server_name example.com;\n\n    # Character encoding.\n    charset utf-8;\n\n    # Max upload size.\n    client_max_body_size 75M;\n\n    # Django media path.\n    location /media {\n        alias /srv/example.com/build/media;\n    }\n\n    # Django static path.\n    location /static {\n        alias /srv/example.com/build/static;\n        expires 90d;\n    }\n\n    # Send all non-media requests to the Django server.\n    location / {\n        uwsgi_pass django;\n        include /srv/example.com/uwsgi_params;\n    }\n}\n</code></pre>\n<p>Make sure that you also have the <code>uwsgi_params</code> file in the specified place. It also comes with <a href=\"https://github.com/andrewscwei/generator-vars-django\">generator-vars-django</a>. If not, it looks like this:</p>\n<pre><code class=\"language-ini\">uwsgi_param  QUERY_STRING       $query_string;\nuwsgi_param  REQUEST_METHOD     $request_method;\nuwsgi_param  CONTENT_TYPE       $content_type;\nuwsgi_param  CONTENT_LENGTH     $content_length;\n\nuwsgi_param  REQUEST_URI        $request_uri;\nuwsgi_param  PATH_INFO          $document_uri;\nuwsgi_param  DOCUMENT_ROOT      $document_root;\nuwsgi_param  SERVER_PROTOCOL    $server_protocol;\nuwsgi_param  HTTPS              $https if_not_empty;\n\nuwsgi_param  REMOTE_ADDR        $remote_addr;\nuwsgi_param  REMOTE_PORT        $remote_port;\nuwsgi_param  SERVER_PORT        $server_port;\nuwsgi_param  SERVER_NAME        $server_name;\n</code></pre>\n<p>Restart Nginx:</p>\n<pre><code class=\"language-bash\">$ sudo service nginx restart\n</code></pre>\n<p>At this point you would probably see a 500 error if you try to access the site.</p>\n<h4 id=\"uwsgi-setup\">uWSGI Setup</h4>\n<p>We will be setting uWSGI up in emperor mode which will be spawning instances for each vassal it finds.</p>\n<p>First create the directories for storing these vassals.</p>\n<pre><code class=\"language-bash\">$ sudo mkdir /etc/uwsgi\n$ sudo mkdir /etc/uwsgi/vassals\n</code></pre>\n<p>Symlink <code>example.com_uwsgi.ini</code> so the emperor can see it:</p>\n<pre><code class=\"language-bash\">$ sudo ln -s /srv/example.com_uwsgi.ini /etc/uwsgi/vassals/\n</code></pre>\n<p>You should tweak this file accordingly. The file looks like this:</p>\n<pre><code class=\"language-ini\">[uwsgi]\n\n# Variables.\nbase-path = /srv\napp-name = example.com\napp-path = %(base-path)/%(app-name)\nenv-path = %(base-path)\n\n# Configurations.\nchdir = %(app-path)/build\nmodule = project.wsgi\nhome = %(env-path)\nmaster = true\nprocesses = 10\nsocket = %(app-path)/%(app-name).sock\nchmod-socket = 666\nvacuum = true\n</code></pre>\n<p>This is the most basic configuration you need to get things up and running. Note that <code>chmod-socket</code> is set to <code>666</code>, which is very permissive. Tweak that accordingly. Also make sure that <code>env-path</code> matches the path to your <code>virtualenv</code>.</p>\n<p>Now try running uWSGI in emperor mode:</p>\n<pre><code class=\"language-bash\">$ sudo uwsgi --emperor /etc/uwsgi/vassals\n</code></pre>\n<p>You may encounter the following issues:</p>\n<ol>\n<li><p>You get an error about permission issues with writing to the UDP socket. You might need to change the owner of <code>/srv/example.com</code> to the Nginx owner/group, which is probably <code>www-data:www-data</code>:</p>\n<pre><code class=\"language-bash\">$ sudo chown -R www-data /srv/example.com\n$ sudo chmod -R 775 /srv/example.com\n</code></pre>\n</li>\n<li><p>You get a warning about running uWSGI in root. You can set the <code>gid</code> and <code>uid</code> to the Nginx user (probably <code>www-data</code>) either in the ini file or in the command, like so:</p>\n<pre><code class=\"language-bash\">$ uwsgi --emperor /etc/uwsgi/vassals --uid www-data --gid www-data\n</code></pre>\n</li>\n</ol>\n<p>The last step is to make sure that the emperor starts whenever the system reboots. <code>upstart</code> finally comes into play. Create a new file:</p>\n<pre><code class=\"language-bash\">$ sudo nano /etc/init/uwsgi.conf\n</code></pre>\n<p>Add the following:</p>\n<pre><code class=\"language-ini\">description &quot;uWSGI Emperor&quot;\n\nstart on runlevel [2345]\nstop on runlevel [!2345]\n\nscript\n    . /srv/bin/activate\n    uwsgi --emperor /etc/uwsgi/vassals\nend script\n</code></pre>\n<p>This script will execute everytime the system boots up and it basically first activates the virtual environment so that all the environment variables are loaded (i.e. the Django secret key), and then kickstarts the emperor.</p>\n<h2 id=\"verifying-the-live-site\">Verifying the Live Site</h2>\n<p>Open up your browser and navigate to the site. It should be now be served properly with Nginx and uWSGI. You might encounter the following issues:</p>\n<ol>\n<li><p>You are still getting a 500 error. The best thing to do is to check the Nginx logs. It&#39;s in <code>/var/log/nginx/error.log</code>.</p>\n</li>\n<li><p>You are instead getting a 400 error. You can debug this using your browser console to see what is wrong. If you get a GET request fail on the domain itself, chances are you forgot to add your domain to the <code>ALLOWED_HOSTS</code> of your Django project settings.</p>\n</li>\n</ol>\n<h2 id=\"related-articles\">Related Articles</h2>\n<ol>\n<li><p><a href=\"http://www.datacommunitydc.org/blog/2013/12/a-tutorial-for-deploying-a-django-application-that-uses-numpy-and-scipy-to-google-compute-engine-using-apache2-and-modwsgi\">A Tutorial for Deploying a Django Application that Uses Numpy and Scipy to Google Compute Engine Using Apache2 and modwsgi</a></p>\n</li>\n<li><p><a href=\"http://www.denisigo.com/2013/07/nginx-uwsgi-python-on-compute-engine/\">Installing Nginx, WWSGI and Python on Google Compute Engine</a></p>\n</li>\n<li><p><a href=\"http://uwsgi-docs.readthedocs.org/en/latest/tutorials/Django_and_nginx.html\">Setting up Django and your web server with uWSGI and Nginx</a></p>\n</li>\n<li><p><a href=\"http://michal.karzynski.pl/blog/2013/06/09/django-nginx-gunicorn-virtualenv-supervisor/\">Setting up Django with Nginx, Gunicorn, virtualenv, supervisor and PostgreSQL</a></p>\n</li>\n<li><p><a href=\"http://guoqiao.farbox.com/post/2014/0416-use-uwsgi-the-right-way\">Using uwsgi the right way</a></p>\n</li>\n<li><p><a href=\"https://www.digitalocean.com/community/tutorials/how-to-set-up-uwsgi-and-nginx-to-serve-python-apps-on-ubuntu-14-04\">How To Set Up uWSGI and Nginx to Serve Python Apps on Ubuntu 14.04</a></p>\n</li>\n</ol>\n"
body: ""
date: '2015-05-31'
id: V22qCyUAAB8PR8xb
uid: google-compute-engine-setup-for-django-app-with-uwsgi
type: log
tags:
    - systems
---
