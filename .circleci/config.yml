defaults: &defaults
  working_directory: /tmp
  docker:
    - image: node:8.4.0

version: 2
jobs:
  build:
    <<: *defaults
    steps:
      - checkout
      - restore_cache:
          keys: 
            - dependency-cache-{{ checksum "package.json" }}
            - dependency-cache-
      - run:
          name: Install NPM dependencies
          command: yarn --pure-lockfile
      - save_cache:
          key: dependency-cache-{{ checksum "package.json" }}
          paths:
            - "node_modules"
      - run: 
          name: Build
          command: npm run build
      - persist_to_workspace:
          root: /tmp
          paths:
            - public
  
  pack:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /tmp
      - run:
          name: Install APT packages
          command: |
            apt-get update -y
            apt-get install jq zip -y
      - run:
          name: Export global environment variables
          command: |
            echo "export PACKAGE_NAME=$(cat package.json | jq -r ".name")" >> .env
            echo "export PACKAGE_VERSION=$(cat package.json | jq -r ".version")" >> .env
            echo "export PACKAGE_FILE=$PACKAGE_NAME-$PACKAGE_VERSION.zip" >> .env
            echo "export PUBLIC_DIR=${PUBLIC_DIR:-public}" >> .env
            echo "export GIT_ORIGIN_URL=`git config --get remote.origin.url`" >> .env
            echo "export IS_RELEASE=`[[ $(git describe --tags) =~ ^v[0-9]+(\.[0-9]+)+(-rc[0-9]+)?(-alpha[0-9]+)?$ ]] && echo true || echo false`" >> .env
      - run:
          name: Pack
          command: |
            source .env
            mkdir -p build
            zip -r build/$PACKAGE_FILE $PUBLIC_DIR
      - store_artifacts:
          path: /tmp/public
      - store_artifacts:
          path: /tmp/build
      
workflows:
  build_for_production:
    jobs:
      - build
      - pack:
          requires:
            - build
